rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user has 'admin' or 'super_admin' role in their user profile
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Specific Role Checks (Future granularity if needed)
    function isGardenAdmin() {
      return isAdmin() || (isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_garden');
    }

    function isRestoAdmin() {
      return isAdmin() || (isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_resto');
    }

    // ========================================
    // USERS COLLECTION
    // ========================================

    match /users/{userId} {
      // Direct access for the owner - NO admin check here to avoid circularity
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Admin access to other profiles
      allow read: if isAdmin();

      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId &&
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) || isAdmin());
      allow delete: if isAdmin();
    }

    // ========================================
    // PUBLIC CONTENT MODULES (ReadOnly Public, Write Admin)
    // ========================================

    // Restaurant Menu
    match /vitedia_menu/{menuId} {
      allow read: if true;
      allow write: if isRestoAdmin();
    }

    // Garden Products (Inventory & Traceability)
    match /garden_products/{productId} {
      allow read: if true;
      allow write: if isGardenAdmin();
    }

    match /gallery/{photoId} {
      allow read, write: if isAuthenticated();
    }

    // Packs (Shop)
    match /packs/{packId} {
        allow read: if true;
        allow write: if isAuthenticated();
    }

      // Garden Inventory (Internal management if separate)
    match /garden_inventory/{itemId} {
      allow read: if true;
      allow write: if isGardenAdmin();
    }

    // Shop Products
    match /epicerie_products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Portfolio Items
    match /portfolio_items/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Elevage Stats & Services
    match /elevage_stats/{statId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /elevage_services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // IA Services
    match /ia_services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ========================================
    // OBSERVATOIRE (Data-Driven Content Hub)
    // ========================================

    // Articles (avec workflow de validation)
    // Articles (avec workflow de validation)
    match /articles/{articleId} {
      // Public: Published only. Admin sees everything.
      allow read: if (resource.data.status == 'published') || isAdmin();

      // Create: Admin only for now (simplified)
      allow create: if isAdmin();

      // Update: Admin only
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // Metrics (Agricultural Data Simulation)
    match /metrics/{metricId} {
      // Public read for live dashboard
      allow read: if true;
      
      // Write: Admin or system (simulation)
      allow write: if isAdmin();
    }

    // Newsletter Subscribers
    match /newsletter_subscribers/{email} {
      // Users can only read their own subscription
      allow read: if isAuthenticated();
      
      // Anyone can subscribe (email verification recommended)
      allow create: if true;
      
      // Users can update their own interests
      allow update: if isAuthenticated();
      
      // Admin can delete
      allow delete: if isAdmin();
    }

    // Authors (Public Profiles for Articles)
    match /authors/{authorId} {
      allow read: if true;
      allow write: if isAdmin();
    }


    // ========================================
    // USER TRANSACTIONS
    // ========================================

    // Reservations
    match /reservations/{reservationId} {
      allow read: if isOwner(resource.data.userId) || isRestoAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isRestoAdmin(); // Confirm/Reject
      allow delete: if isRestoAdmin();
    }

    // Orders (Shop)
    match /orders/{orderId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin(); // Update status
      allow delete: if false; // Archive only
    }

    // ========================================
    // SYSTEM & UTILS
    // ========================================

    // Chat Sessions
    match /chatSessions/{sessionId} {
      // Allow read/write to the owner of the chat session, and read to admins
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow write: if isOwner(resource.data.userId);
    }

    // Media (Images)
    match /media/{mediaId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Logs (Admin Only)
    match /logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin(); // System logs
    }

    // Site Content (Public read, Admin write)
    match /site_content/{docId} {
      allow read: if true; // Public access for chatbot
      allow write: if isAdmin(); // Only admins can update
    }
  }
}
