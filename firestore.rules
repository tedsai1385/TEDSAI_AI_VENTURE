rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user has 'admin' or 'super_admin' role in their user profile
    function isAdmin() {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin' || 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Specific Role Checks (Future granularity if needed)
    function isGardenAdmin() {
      return isAdmin() || (isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_garden');
    }
    
    function isRestoAdmin() {
      return isAdmin() || (isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin_resto');
    }

    // ========================================
    // USERS COLLECTION
    // ========================================
    
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId); // Users sign up themselves
      allow update: if isOwner(userId) && 
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) || isAdmin()); // Only admin can change roles
      allow delete: if isAdmin();
    }
    
    // ========================================
    // PUBLIC CONTENT MODULES (ReadOnly Public, Write Admin)
    // ========================================
    
    // Restaurant Menu
    match /vitedia_menu/{menuId} {
      allow read: if true;
      allow write: if isRestoAdmin();
    }
    
    // Garden Products (Inventory & Traceability)
    match /garden_products/{productId} {
      allow read: if true;
      allow write: if isGardenAdmin();
    }

      // Garden Inventory (Internal management if separate)
    match /garden_inventory/{itemId} {
      allow read: if true;
      allow write: if isGardenAdmin();
    }
    
    // Shop Products
    match /epicerie_products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Elevage Stats & Services
    match /elevage_stats/{statId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /elevage_services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // IA Services
    match /ia_services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ========================================
    // BLOG (Observatoire)
    // ========================================
    
    match /observatoire_posts/{postId} {
      // Public validation: Published only. Admin sees everything.
      allow read: if (resource.data.status == 'published') || isAdmin();
      
      // Submission: Auth users can create "pending" posts
      allow create: if isAuthenticated() && request.resource.data.status == 'pending';
      
      // Update: Admin Only (Publish/Reject)
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // USER TRANSACTIONS
    // ========================================
    
    // Reservations
    match /reservations/{reservationId} {
      allow read: if isOwner(resource.data.userId) || isRestoAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isRestoAdmin(); // Confirm/Reject
      allow delete: if isRestoAdmin();
    }
    
    // Orders (Shop)
    match /orders/{orderId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin(); // Update status
      allow delete: if false; // Archive only
    }
    
    // ========================================
    // SYSTEM & UTILS
    // ========================================
    
    // Chat Sessions
    match /chatSessions/{sessionId} {
      allow read, write: if true; // Open for demo purposes (or refine to owner)
    }

    // Media (Images)
    match /media/{mediaId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Logs (Admin Only)
    match /logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin(); // System logs
    }
  }
}
